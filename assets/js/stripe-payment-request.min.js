jQuery(function(i){"use strict";var s,p=Stripe(wc_stripe_payment_request_params.stripe.key),o={getAjaxURL:function(e){return wc_stripe_payment_request_params.ajax_url.toString().replace("%%endpoint%%","wc_stripe_"+e)},getCartDetails:function(){var e={security:wc_stripe_payment_request_params.nonce.payment};i.ajax({type:"POST",data:e,url:o.getAjaxURL("get_cart_details"),success:function(e){o.startPaymentRequest(e)}})},getAttributes:function(){var e=i(".variations_form").find(".variations select"),a={},n=0,r=0;return e.each(function(){var e=i(this).data("attribute_name")||i(this).attr("name"),t=i(this).val()||"";0<t.length&&r++,n++,a[e]=t}),{count:n,chosenCount:r,data:a}},processSource:function(e,t){var a=o.getOrderData(e,t);return i.ajax({type:"POST",data:a,dataType:"json",url:o.getAjaxURL("create_order")})},getOrderData:function(e,t){var a=e.source,n=a.owner.email,r=a.owner.phone,i=a.owner.address,s=a.owner.name,p=e.shippingAddress,o={_wpnonce:wc_stripe_payment_request_params.nonce.checkout,billing_first_name:null!==s?s.split(" ").slice(0,1).join(" "):"",billing_last_name:null!==s?s.split(" ").slice(1).join(" "):"",billing_company:"",billing_email:null!==n?n:e.payerEmail,billing_phone:null!==r?r:e.payerPhone.replace("/[() -]/g",""),billing_country:null!==i?i.country:"",billing_address_1:null!==i?i.line1:"",billing_address_2:null!==i?i.line2:"",billing_city:null!==i?i.city:"",billing_state:null!==i?i.state:"",billing_postcode:null!==i?i.postal_code:"",shipping_first_name:"",shipping_last_name:"",shipping_company:"",shipping_country:"",shipping_address_1:"",shipping_address_2:"",shipping_city:"",shipping_state:"",shipping_postcode:"",shipping_method:[null===e.shippingOption?null:e.shippingOption.id],order_comments:"",payment_method:"stripe",ship_to_different_address:1,terms:1,stripe_source:a.id,payment_request_type:t};return p&&(o.shipping_first_name=p.recipient.split(" ").slice(0,1).join(" "),o.shipping_last_name=p.recipient.split(" ").slice(1).join(" "),o.shipping_company=p.organization,o.shipping_country=p.country,o.shipping_address_1=void 0===p.addressLine[0]?"":p.addressLine[0],o.shipping_address_2=void 0===p.addressLine[1]?"":p.addressLine[1],o.shipping_city=p.city,o.shipping_state=p.region,o.shipping_postcode=p.postalCode),o},getErrorMessageHTML:function(e){return i('<div class="woocommerce-error" />').text(e)},abortPayment:function(e,t){if(e.complete("fail"),i(".woocommerce-error").remove(),wc_stripe_payment_request_params.is_product_page){var a=i(".product");a.before(t),i("html, body").animate({scrollTop:a.prev(".woocommerce-error").offset().top},600)}else{var n=i(".shop_table.cart").closest("form");n.before(t),i("html, body").animate({scrollTop:n.prev(".woocommerce-error").offset().top},600)}},completePayment:function(e,t){o.block(),e.complete("success"),window.location=t},block:function(){i.blockUI({message:null,overlayCSS:{background:"#fff",opacity:.6}})},updateShippingOptions:function(e,t){var a={security:wc_stripe_payment_request_params.nonce.shipping,country:t.country,state:t.region,postcode:t.postalCode,city:t.city,address:void 0===t.addressLine[0]?"":t.addressLine[0],address_2:void 0===t.addressLine[1]?"":t.addressLine[1],payment_request_type:s};return i.ajax({type:"POST",data:a,url:o.getAjaxURL("get_shipping_options")})},updateShippingDetails:function(e,t){var a={security:wc_stripe_payment_request_params.nonce.update_shipping,shipping_method:[t.id],payment_request_type:s};return i.ajax({type:"POST",data:a,url:o.getAjaxURL("update_shipping_method")})},addToCart:function(){var e=i(".single_add_to_cart_button").val();i(".single_variation_wrap").length&&(e=i(".single_variation_wrap").find('input[name="product_id"]').val());var n={security:wc_stripe_payment_request_params.nonce.add_to_cart,product_id:e,qty:i(".quantity .qty").val(),attributes:i(".variations_form").length?o.getAttributes().data:[]},t=i("form.cart").serializeArray();return i.each(t,function(e,t){if(/^addon-/.test(t.name))if(/\[\]$/.test(t.name)){var a=t.name.substring(0,t.name.length-2);n[a]?n[a].push(t.value):n[a]=[t.value]}else n[t.name]=t.value}),i.ajax({type:"POST",data:n,url:o.getAjaxURL("add_to_cart")})},clearCart:function(){var e={security:wc_stripe_payment_request_params.nonce.clear_cart};return i.ajax({type:"POST",data:e,url:o.getAjaxURL("clear_cart"),success:function(e){}})},getRequestOptionsFromLocal:function(){return{total:wc_stripe_payment_request_params.product.total,currency:wc_stripe_payment_request_params.checkout.currency_code,country:wc_stripe_payment_request_params.checkout.country_code,requestPayerName:!0,requestPayerEmail:!0,requestPayerPhone:!0,requestShipping:wc_stripe_payment_request_params.product.requestShipping,displayItems:wc_stripe_payment_request_params.product.displayItems}},startPaymentRequest:function(e){var a,t;a=wc_stripe_payment_request_params.is_product_page?t=o.getRequestOptionsFromLocal():(t={total:e.order_data.total,currency:e.order_data.currency,country:e.order_data.country_code,requestPayerName:!0,requestPayerEmail:!0,requestPayerPhone:!0,requestShipping:!!e.shipping_required,displayItems:e.order_data.displayItems},e.order_data);var n=p.paymentRequest(t),r=p.elements({locale:wc_stripe_payment_request_params.button.locale}).create("paymentRequestButton",{paymentRequest:n,style:{paymentRequestButton:{type:wc_stripe_payment_request_params.button.type,theme:wc_stripe_payment_request_params.button.theme,height:wc_stripe_payment_request_params.button.height+"px"}}});n.canMakePayment().then(function(e){var t=[];if(e){if(s=e.applePay?"apple_pay":"payment_request_api",wc_stripe_payment_request_params.is_product_page){var a=i(".single_add_to_cart_button");r.on("click",function(e){a.is(".disabled")?(e.preventDefault(),a.is(".wc-variation-is-unavailable")?window.alert(wc_add_to_cart_variation_params.i18n_unavailable_text):a.is(".wc-variation-selection-needed")&&window.alert(wc_add_to_cart_variation_params.i18n_make_a_selection_text)):0<t.length?(e.preventDefault(),window.alert(t)):o.addToCart()}),i(document.body).on("woocommerce_variation_has_changed updated_addons",function(){i("#wc-stripe-payment-request-button").block({message:null}),i.when(o.getSelectedProductData()).then(function(e){i.when(n.update({total:e.total,displayItems:e.displayItems})).then(function(){i("#wc-stripe-payment-request-button").unblock()})})}),i(".quantity").on("keyup mouseup",".qty",this.debounce(250,function(){i("#wc-stripe-payment-request-button").block({message:null}),t=[],i.when(o.getSelectedProductData()).then(function(e){e.error?(t=[e.error],i("#wc-stripe-payment-request-button").unblock()):i.when(n.update({total:e.total,displayItems:e.displayItems})).then(function(){i("#wc-stripe-payment-request-button").unblock()})})}))}i("#wc-stripe-payment-request-button").length&&(i("#wc-stripe-payment-request-wrapper, #wc-stripe-payment-request-button-separator").show(),r.mount("#wc-stripe-payment-request-button"))}}),n.on("shippingaddresschange",function(t){i.when(o.updateShippingOptions(a,t.shippingAddress)).then(function(e){t.updateWith({status:e.result,shippingOptions:e.shipping_options,total:e.total,displayItems:e.displayItems})})}),n.on("shippingoptionchange",function(t){i.when(o.updateShippingDetails(a,t.shippingOption)).then(function(e){"success"===e.result&&t.updateWith({status:"success",total:e.total,displayItems:e.displayItems}),"fail"===e.result&&t.updateWith({status:"fail"})})}),n.on("source",function(t){"no"===wc_stripe_payment_request_params.stripe.allow_prepaid_card&&"prepaid"===t.source.card.funding?o.abortPayment(t,o.getErrorMessageHTML(wc_stripe_payment_request_params.i18n.no_prepaid_card)):i.when(o.processSource(t,s)).then(function(e){"success"===e.result?o.completePayment(t,e.redirect):o.abortPayment(t,e.messages)})})},getSelectedProductData:function(){var e=i(".single_add_to_cart_button").val();i(".single_variation_wrap").length&&(e=i(".single_variation_wrap").find('input[name="product_id"]').val());var t=(i("#product-addons-total").data("price_data")||[]).reduce(function(e,t){return e+t.cost},0),a={security:wc_stripe_payment_request_params.nonce.get_selected_product_data,product_id:e,qty:i(".quantity .qty").val(),attributes:i(".variations_form").length?o.getAttributes().data:[],addon_value:t};return i.ajax({type:"POST",data:a,url:o.getAjaxURL("get_selected_product_data")})},debounce:function(n,r,i){var s;return function(){var e=this,t=arguments,a=i&&!s;clearTimeout(s),s=setTimeout(function(){s=null,i||r.apply(e,t)},n),a&&r.apply(e,t)}},init:function(){wc_stripe_payment_request_params.is_product_page?o.startPaymentRequest(""):o.getCartDetails()}};o.init(),i(document.body).on("updated_cart_totals",function(){o.init()}),i(document.body).on("updated_checkout",function(){o.init()})});
